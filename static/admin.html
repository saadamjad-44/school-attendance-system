<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard / منتظم ڈیش بورڈ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <h1>Admin Dashboard / منتظم ڈیش بورڈ</h1>
            <div class="nav">
                <button onclick="showSection('teachers')" class="active">Teachers / استاد</button>
                <button onclick="showSection('students')">Students / طلباء</button>
                <button onclick="showSection('classes')">Classes / کلاسز</button>
                <button onclick="handleLogout()">Logout / لاگ آوٹ</button>
            </div>
            <p id="error" class="error"></p>
            <p id="success" class="success"></p>
        </div>

        <!-- Teachers Section -->
        <div id="teachers-section" class="section">
            <h2>Manage Teachers / استاد کا انتظام</h2>
            <div class="form-inline">
                <div class="form-group">
                    <label>Username / صارف نام</label>
                    <input type="text" id="teacher-username">
                </div>
                <div class="form-group">
                    <label>Name / نام</label>
                    <input type="text" id="teacher-name">
                </div>
                <div class="form-group">
                    <label>Password / پاس ورڈ</label>
                    <input type="password" id="teacher-password">
                </div>
                <button onclick="addTeacherHandler()">Add Teacher / استاد شامل کریں</button>
            </div>
            <table id="teachers-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username / صارف نام</th>
                        <th>Name / نام</th>
                        <th>Assigned Class / تفویض کردہ کلاس</th>
                        <th>Actions / اعمال</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Students Section -->
        <div id="students-section" class="section" style="display:none;">
            <h2>Manage Students / طلباء کا انتظام</h2>
            <div class="form-inline">
                <div class="form-group">
                    <label>Name / نام</label>
                    <input type="text" id="student-name">
                </div>
                <div class="form-group">
                    <label>Roll No / رول نمبر</label>
                    <input type="text" id="student-roll">
                </div>
                <div class="form-group">
                    <label>Class / کلاس</label>
                    <select id="student-class"></select>
                </div>
                <div class="form-group">
                    <label>Parent Phone / والدین فون</label>
                    <input type="text" id="student-phone">
                </div>
                <button onclick="addStudentHandler()">Add Student / طالب علم شامل کریں</button>
            </div>
            <div class="form-inline">
                <div class="form-group">
                    <label>Filter by Class / کلاس کے مطابق فلٹر کریں</label>
                    <select id="filter-class" onchange="loadStudents()">
                        <option value="">All Classes / تمام کلاسز</option>
                    </select>
                </div>
            </div>
            <table id="students-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name / نام</th>
                        <th>Roll No / رول نمبر</th>
                        <th>Class / کلاس</th>
                        <th>Parent Phone / والدین فون</th>
                        <th>Actions / اعمال</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Classes Section -->
        <div id="classes-section" class="section" style="display:none;">
            <h2>Manage Classes / کلاسز کا انتظام</h2>
            <div class="form-inline">
                <div class="form-group">
                    <label>Class Name / کلاس کا نام</label>
                    <input type="text" id="class-name" placeholder="e.g., 6-A">
                </div>
                <button onclick="addClassHandler()">Add Class / کلاس شامل کریں</button>
            </div>
            <table id="classes-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Class Name / کلاس کا نام</th>
                        <th>Assigned Teacher / تفویض کردہ استاد</th>
                        <th>Actions / اعمال</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
        let currentSection = 'teachers';
        let classesData = [];
        let teachersData = [];

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`${section}-section`).style.display = 'block';
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            currentSection = section;

            if (section === 'teachers') loadTeachers();
            else if (section === 'students') loadStudents();
            else if (section === 'classes') loadClasses();
        }

        async function loadTeachers() {
            try {
                teachersData = await getTeachers();
                const tbody = document.querySelector('#teachers-table tbody');
                tbody.innerHTML = teachersData.map(t => `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.username}</td>
                        <td>${t.name_en}</td>
                        <td>${t.class_name || 'Not Assigned / تفویض نہیں'}</td>
                        <td><button onclick="deleteTeacherHandler(${t.id})">Delete / حذف کریں</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                showError(error.message);
            }
        }

        async function addTeacherHandler() {
            clearMessages();
            const username = document.getElementById('teacher-username').value;
            const name = document.getElementById('teacher-name').value;
            const password = document.getElementById('teacher-password').value;

            if (!username || !name || !password) {
                showError('All fields required / تمام فیلڈز ضروری ہیں');
                return;
            }

            try {
                await addTeacher({ username, password, name_en: name });
                showSuccess('Teacher added / استاد شامل کیا گیا');
                document.getElementById('teacher-username').value = '';
                document.getElementById('teacher-name').value = '';
                document.getElementById('teacher-password').value = '';
                loadTeachers();
            } catch (error) {
                showError(error.message);
            }
        }

        async function deleteTeacherHandler(id) {
            if (!confirm('Delete this teacher? / اس استاد کو حذف کریں؟')) return;
            try {
                await deleteTeacher(id);
                showSuccess('Teacher deleted / استاد حذف کیا گیا');
                loadTeachers();
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadStudents() {
            try {
                const classId = document.getElementById('filter-class')?.value || null;
                const students = await getStudents(classId);
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name_en}</td>
                        <td>${s.roll_no}</td>
                        <td>${s.class_id}</td>
                        <td>${s.parent_phone || '-'}</td>
                        <td><button onclick="deleteStudentHandler(${s.id})">Delete / حذف کریں</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                showError(error.message);
            }
        }

        async function addStudentHandler() {
            clearMessages();
            const name = document.getElementById('student-name').value;
            const roll = document.getElementById('student-roll').value;
            const classId = document.getElementById('student-class').value;
            const phone = document.getElementById('student-phone').value;

            if (!name || !roll || !classId) {
                showError('Name, Roll No, and Class required / نام، رول نمبر اور کلاس ضروری ہیں');
                return;
            }

            try {
                await addStudent({ name_en: name, roll_no: roll, class_id: parseInt(classId), parent_phone: phone });
                showSuccess('Student added / طالب علم شامل کیا گیا');
                document.getElementById('student-name').value = '';
                document.getElementById('student-roll').value = '';
                document.getElementById('student-phone').value = '';
                loadStudents();
            } catch (error) {
                showError(error.message);
            }
        }

        async function deleteStudentHandler(id) {
            if (!confirm('Delete this student? / اس طالب علم کو حذف کریں؟')) return;
            try {
                await deleteStudent(id);
                showSuccess('Student deleted / طالب علم حذف کیا گیا');
                loadStudents();
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadClasses() {
            try {
                classesData = await getClasses();
                const tbody = document.querySelector('#classes-table tbody');
                tbody.innerHTML = classesData.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>
                            <select onchange="assignTeacherHandler(${c.id}, this.value)">
                                <option value="">Select Teacher / استاد منتخب کریں</option>
                                ${teachersData.map(t => `
                                    <option value="${t.id}" ${t.id === c.teacher_id ? 'selected' : ''}>
                                        ${t.name_en}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td>${c.teacher_name || 'Not Assigned / تفویض نہیں'}</td>
                    </tr>
                `).join('');

                // Populate class dropdowns
                const classSelect = document.getElementById('student-class');
                const filterSelect = document.getElementById('filter-class');
                const options = classesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                classSelect.innerHTML = '<option value="">Select Class / کلاس منتخب کریں</option>' + options;
                if (filterSelect) filterSelect.innerHTML = '<option value="">All Classes / تمام کلاسز</option>' + options;
            } catch (error) {
                showError(error.message);
            }
        }

        async function addClassHandler() {
            clearMessages();
            const name = document.getElementById('class-name').value;
            if (!name) {
                showError('Class name required / کلاس کا نام ضروری ہے');
                return;
            }

            try {
                await addClass({ name });
                showSuccess('Class added / کلاس شامل کی گئی');
                document.getElementById('class-name').value = '';
                loadClasses();
            } catch (error) {
                showError(error.message);
            }
        }

        async function assignTeacherHandler(classId, teacherId) {
            try {
                await assignTeacher(classId, teacherId ? parseInt(teacherId) : null);
                showSuccess('Teacher assigned / استاد تفویض کیا گیا');
                loadClasses();
            } catch (error) {
                showError(error.message);
            }
        }

        async function handleLogout() {
            await logout();
            window.location.href = '/login';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTeachers();
            await loadClasses();
        });
    </script>
</body>
</html>
